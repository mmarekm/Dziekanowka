@page "/"
@using Dziekanowka.Mechanizm
@inject LadowanieGracza ladowanieGracza
@inject Dzwieki dzwieki
@implements IDisposable
@using System.Text.Json
<div class="kontener @(czyAnimacjaWyjscia ? "fade-out" : "fade-in")">
    @switch (aktualnyEkran)
    {
        case EkranGry.Start:
            <Start NaStartGry="WywolajStartGry" />
            break;
        case EkranGry.Gospodarstwo:
            <Gospodarstwo Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.ZaBrama:
            <ZaBrama Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.GarazGospodarczy:
            <GarazGospodarczy Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.Studnia:
            <Studnia Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.Sklepik:
            <Sklepik Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.PoleIntro:
            <PoleIntro Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.Pole1:
            <Pole1 Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
            break;
        case EkranGry.AnimacjaTraktora:
            <AnimacjaTraktora />
            break;
        case EkranGry.AnimacjaTraktoraPowrot:
            <AnimacjaTraktoraPowrot />
            break;
    }
    @if (aktualnyEkran != EkranGry.Start)
    {
        <div class="abs @KlasaPowitania">Witaj! +++ @gracz!.Statystyki.BonusDzienny +++</div>
    }
</div>

@code {
    private EkranGry aktualnyEkran = EkranGry.Start;
    private bool czyAnimacjaWyjscia = false;
    private EkranGry nastepnyEkran;
    private Gracz? gracz => ladowanieGracza.AktualnyGracz;
    private bool Powitaj { get; set; } = false;
    private bool Znikanie { get; set; } = false;
    private bool czekaNaPowitanie = false;
    private string KlasaPowitania => Powitaj ? (Znikanie ? "powitanieDzienne znikaj" : "powitanieDzienne") : "ukryty";
    protected override void OnInitialized()
    {
        ladowanieGracza.NowyDzienEvent += OnNowyDzien;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (czekaNaPowitanie && aktualnyEkran != EkranGry.Start)
        {
            czekaNaPowitanie = false;
            await PowitanieDnia();
        }
    }
    private void OnNowyDzien()
    {
        czekaNaPowitanie = true;
    }
    private async Task PowitanieDnia()
    {
        Powitaj = true;
        Znikanie = false;
        StateHasChanged();
        await Task.Delay(100);
        Znikanie = true;
        StateHasChanged();
        await Task.Delay(3000);
        Powitaj = false;
        Znikanie = false;
        StateHasChanged();
    }
    public void Dispose()
    {
        ladowanieGracza.NowyDzienEvent -= OnNowyDzien;
    }
    private async Task GraTlo(EkranGry ekran)
    {
        switch (ekran)
        {
            case EkranGry.Gospodarstwo:
                await dzwieki.GraTlo("mp3/Tla/gospodarstwo.mp3");
                break;
            case EkranGry.GarazGospodarczy:
                await dzwieki.GraTlo("mp3/Tla/garazGospodarczy.mp3");
                break;
            case EkranGry.Sklepik:
                await dzwieki.GraTlo("mp3/Tla/sklepik.mp3");
                break;
            default:
                break;
        }
    }
    private async Task ZmienEkran(EkranGry ekran)
    {
        gracz!.Statystyki.Ekran = ekran;
        await ladowanieGracza.ZapiszAktualnegoGracza();
        nastepnyEkran = ekran;
        czyAnimacjaWyjscia = true;
        StateHasChanged();
        await Task.Delay(300);
        aktualnyEkran = nastepnyEkran;
        czyAnimacjaWyjscia = false;
        StateHasChanged();
        await GraTlo(ekran);
        await Task.Delay(10);
    }
    private async Task WywolajStartGry(string nazwaGracza)
    {
        if (string.IsNullOrWhiteSpace(nazwaGracza))
            return;
        await ladowanieGracza.ZaladujLubUtworzGracza(nazwaGracza);
        EkranGry startowyEkran = gracz!.Statystyki.Ekran;
        if (startowyEkran == EkranGry.AnimacjaTraktora || startowyEkran == EkranGry.AnimacjaTraktoraPowrot)
            startowyEkran = EkranGry.Gospodarstwo;
        await ZmienEkran(startowyEkran);
    }
}