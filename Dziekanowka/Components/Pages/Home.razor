@page "/"
@using Dziekanowka.Mechanizm
@inject LadowanieGracza ladowanieGracza
@implements IDisposable
@using System.Text.Json
@switch (aktualnyEkran)
{
    case EkranGry.Start:
        <Start NaStartGry="WywolajStartGry" />
        break;
    case EkranGry.Gospodarstwo:
        <Gospodarstwo @ref="gospodarstwoRef" Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
        break;
    case EkranGry.ZaBrama:
        <ZaBrama Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
        break;
    case EkranGry.Studnia:
        <Studnia Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
        break;
    case EkranGry.Sklepik:
        <Sklepik Gracz="gracz!" NaZmianeEkranu="ZmienEkran" />
        break;
}

@code {
    private EkranGry aktualnyEkran = EkranGry.Start;
    private Gracz? gracz => ladowanieGracza.AktualnyGracz;
    private Gospodarstwo? gospodarstwoRef;
    private bool czekaNaPowitanie = false;
    protected override void OnInitialized()
    {
        ladowanieGracza.NowyDzienEvent += OnNowyDzien;
    }
    private void OnNowyDzien()
    {
        if (gospodarstwoRef != null)
            _ = gospodarstwoRef.PowitanieDnia();
        else
            czekaNaPowitanie = true;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (czekaNaPowitanie && gospodarstwoRef != null)
        {
            czekaNaPowitanie = false;
            await gospodarstwoRef.PowitanieDnia();
        }
    }
    public void Dispose()
    {
        ladowanieGracza.NowyDzienEvent -= OnNowyDzien;
    }
    private void ZmienEkran(EkranGry ekran)
    {
        aktualnyEkran = ekran;
    }
    private async Task WywolajStartGry(string nazwaGracza)
    {
        if (string.IsNullOrWhiteSpace(nazwaGracza))
            return;
        await ladowanieGracza.ZaladujLubUtworzGracza(nazwaGracza);
        ZmienEkran(EkranGry.Gospodarstwo);
    }
}