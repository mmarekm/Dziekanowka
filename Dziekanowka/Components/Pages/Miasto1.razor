@using Dziekanowka.Mechanizm
@using Dziekanowka.Gracza
@inject LadowanieGracza ladowanieGracza
@implements IDisposable
<div class="miasto1Widok widok rel">
    <div class="abs stanPaliwaMiasto">
        <div class="kanisterGarazGospodarczy"><img class="obrazekWypelnia" src="img/przedmioty/kanister.png" /></div>
        <progress class="pasekPaliwa" value="@Gracz.Paliwo.IloscPaliwa" max="@Gracz.Paliwo.MaksymalnaIloscPaliwa" style="--procent: @((int)((double)Gracz.Paliwo.IloscPaliwa / Gracz.Paliwo.MaksymalnaIloscPaliwa * 100) / 10) "></progress>
    </div>
    <div class="abs sprzedawanieMiasto1 @(Gracz.Monety < 8 ? "nieMoznaKliknac" : "cPoint") @(Gracz.Paliwo.IloscPaliwa < 1 ? "" : "ukryty")" @onclick="SprzedazJednego">
        <div class="sprzedawcaMiasto1"><img class="obrazekWypelnia" src="img/pole/sprzedawcaPoleIntro.png" /></div>
        <div class="cenaDrogaPoleIntro">
            <div class="tylko1PoleIntro">1 <img class="obrazekWypelnia" src="img/przedmioty/kanister.png" /></div>
            <div class="cenaPoleIntro">8 <img class="obrazekWypelnia" src="img/przedmioty/moneta.png" /></div>
        </div>
    </div>
    <div class="abs lBiletowMiasto1">@Gracz.Przedmiot("biletAutobus").Ilosc</div>
    <div class="abs miasto1Powrot"><button class="wyroznionyGuzik" @onclick="DoDomu"><img src="img/miasto/miasto1Powrot.png" /></button></div>
    <div class="abs miasto1doSklepDrobiu"><button class="wyroznionyGuzik" @onclick="async () => await NaZmianeEkranu.InvokeAsync(EkranGry.SklepDrobiu)"><img src="img/miasto/miastoDoSklepDrobiu.png" /></button></div>
    <div class="abs miasto1doSzkoly"><button class="wyroznionyGuzik" @onclick="async () => await NaZmianeEkranu.InvokeAsync(EkranGry.SzkolaIntro)"><img src="img/miasto/miastoDoSzkoly.png" /></button></div>
    <div class="abs miasto1DoKiosk"><button class="wyroznionyGuzik" @onclick="DoKiosku"><img src="img/miasto/miasto1DoKiosk.png" /></button></div>
    <div class="abs autobusAnimacjaM1 @klasaAutobusu" @onclick="WsiadzDoAutobusu"><img class="obrazekWypelnia" src="img/miasto/autobus.png" /></div>
</div>
@code {
    [Parameter] public Gracz Gracz { get; set; } = null!;
    [Parameter] public EventCallback<EkranGry> NaZmianeEkranu { get; set; }
    private string klasaAutobusu = "autobusUkryty";
    private bool moznaWsiasc = false;
    private CancellationTokenSource? _cts;
    protected override void OnInitialized()
    {
        _ = PetlaAutobusu();
    }
    private async Task PetlaAutobusu()
    {
        _cts = new CancellationTokenSource();
        var token = _cts.Token;
        try
        {
            while (!token.IsCancellationRequested)
            {
                await Task.Delay(5000, token);
                klasaAutobusu = "autobusJedzieM1";
                moznaWsiasc = false;
                StateHasChanged();
                await Task.Delay(1000, token);
                klasaAutobusu = "autobusStoiM1";
                moznaWsiasc = true;
                StateHasChanged();
                await Task.Delay(2000, token);
                moznaWsiasc = false;
                klasaAutobusu = "autobusOdjedzieM1";
                StateHasChanged();
                await Task.Delay(1000, token);
                klasaAutobusu = "autobusUkrytyM1";
                StateHasChanged();
            }
        }
        catch (TaskCanceledException) { }
    }
    private async Task SprzedazJednego()
    {
        if (Gracz.Monety < 8) return;
        Gracz.Monety -= 8;
        Gracz.Paliwo.IloscPaliwa++;
        await ladowanieGracza.ZapiszAktualnegoGracza();
    }
    public async Task DoDomu()
    {
        if (Gracz.Paliwo.IloscPaliwa < 1) return;
        Gracz.Paliwo.IloscPaliwa--;
        await NaZmianeEkranu.InvokeAsync(EkranGry.SamochodDoDomu);
        await Task.Delay(5000);
        await NaZmianeEkranu.InvokeAsync(EkranGry.Garaz);
    }
    public async Task DoKiosku()
    {
        Gracz.Statystyki.Kiosk = 1;
        await NaZmianeEkranu.InvokeAsync(EkranGry.Kiosk);
    }
    public async Task WsiadzDoAutobusu()
    {
        if (Gracz.Przedmiot("biletAutobus").Ilosc < 1 || !moznaWsiasc) return;
        Gracz.Przedmiot("biletAutobus").Ilosc--;
        await NaZmianeEkranu.InvokeAsync(EkranGry.Miasto2);
    }
    public void Dispose()
    {
        _cts?.Cancel();
    }
}